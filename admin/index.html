<!--suppress HtmlUnknownTarget -->
<html>
<head>
    <style>
        /*noinspection CssUnusedSymbol*/
        .msl-controller-error {
            display: inline-block;
            padding-left: 0.3em;
            color: #f00;
            border-color: #af2b2b;
            vertical-align: middle;
            font-size: 0.875em;
        }

        /*noinspection CssUnusedSymbol*/
        .msl-disabled {
            cursor: not-allowed;
            background-color: #eaeded;
            color: #cad2d3;
        }
    </style>
</head>

<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/jquery.multiselect-1.13.css"/>

<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>

<link rel="stylesheet" type="text/css" href="lib/css/pure-min.css"/>
<link rel="stylesheet" type="text/css" href="lib/css/grids-responsive-min.css"/>

<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>

<script type="text/javascript" src="../../lib/js/jquery.multiselect-1.13.min.js"></script>

<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>

<script src="lib/js/jquery.validate.js"></script>
<script src="lib/js/additional-methods.js"></script>

<script src="lib/js/msl-settings.js"></script>

<script type="text/javascript">
  systemDictionary = {
    'adapterSettings': {
      'en': 'Configure the controller and select the Zones',
      'de': 'Konfiguration des WiFi iBox Controllers und der Zonen',
      'ru': 'Настройка контроллера и выбор зон',
    },
    'onSaveAdapter': {
      'en': 'on save adapter restarts with new config immediately.',
      'de': 'Werden Einstellungen gespeichert, startet der Adapter sofort neu.',
      'ru': 'Сразу после сохранения настроек драйвер перезапуститься с новыми значениями',
    },
    'selectController': {'en': 'Please select controller . . ', 'de': 'Bitte Controller wählen . . .', 'ru': 'Выберите контроллер'},

    // Tabs
    'tabController': {'en': 'Controller', 'de': 'Controller', 'ru': 'Контроллер'},
    'tabZones': {'en': 'Zones', 'de': 'Zonen', 'ru': 'Зоны'},

    'controllerParameter': {'en': 'Controller-Parameter', 'de': 'Controller-Parameter', 'ru': 'Параметры контроллера'},
    'createZones': {'en': 'Create zones', 'de': 'Zonen anlegen', 'ru': 'Создать зоны'},

    // Controller
    'conType': {'en': 'Type', 'de': 'Typ', 'ru': 'Тип'},
    'conIp': {'en': 'IP', 'de': 'IP', 'ru': 'IP'},
    'conPort': {'en': 'Port', 'de': 'Port', 'ru': 'Порт'},
    'conRepeatCommand': {'en': 'Repetition of Commands', 'de': 'Befehlswiederholungen', 'ru': 'Повтор команд'},
    'conPauseBetweenCommands': {'en': 'Pause between two commands', 'de': 'Pause zwischen zwei Befehlen', 'ru': 'Пауза между командами'},

    // Controller Error
    'noController': {
      'en': 'There is no controller in your network.',
      'de': 'Es wurde kein Controller im Netzwerk gefunden.',
      'ru': 'Ничего не найдено',
    },
    'conError': {'en': 'Error in your controller-parameter!', 'de': 'Fehler in Controller-Parameter!', 'ru': 'Ошибка в настройках контроллера'},
    'conIpError': {'en': 'IP has a wrong format.', 'de': 'IP hat ein falsches Format.', 'ru': 'Неверный формат IP'},
    'conPortError': {
      'en': 'Wrong format (you can only use integers)',
      'de': 'Das Format ist nicht korrekt (nur ganze Zahlen sind erlaubt)!',
      'ru': 'Неправильный формат (разрешены только целые числа)',
    },
    'conRepeatCommandError': {
      'en': 'Wrong format (you can only use integers)',
      'de': 'Das Format ist nicht korrekt (nur ganze Zahlen sind erlaubt)!',
      'ru': 'Неправильный формат (разрешены только целые числа)?',
    },
    'conPauseBetweenCommandsError': {
      'en': 'Wrong format (you can only use integers)',
      'de': 'Das Format ist nicht korrekt (nur ganze Zahlen sind erlaubt)!',
      'ru': 'Неправильный формат (разрешены только целые числа)',
    },

    // Zonen
    'thactive': {'en': 'active', 'de': 'aktiv', 'ru': 'активно'},
    'thzone': {'en': 'Zone', 'de': 'Zone', 'ru': 'Зона'},
    'thname': {'en': 'Name (Zone)', 'de': 'Name (Zone)', 'ru': 'Имя зоны'},
    'thtype': {'en': 'Type', 'de': 'Typ', 'ru': 'Тип'},
    'thnametype': {'en': 'Name (Type)', 'de': 'Name (Typ)', 'ru': 'Имя типа'},
    'throom': {'en': 'Room', 'de': 'Raum', 'ru': 'Комната'},
    'thfunction': {'en': 'Function(s)', 'de': 'Gruppe(n)', 'ru': 'Функция'},

    'notype': {
      'en': '-------------------------', 'de': '-------------------------', 'ru': '-------------------------',
    },

    'nozone': {'en': '----------', 'de': '----------', 'ru': '----------'},
    'zone1': {'en': 'one', 'de': 'eins', 'ru': 'один'},
    'zone2': {'en': 'two', 'de': 'zwei', 'ru': 'два'},
    'zone3': {'en': 'three', 'de': 'drei', 'ru': 'три'},
    'zone4': {'en': 'four', 'de': 'vier', 'ru': 'четыре'},
    'zone5': {'en': 'five', 'de': 'fünf', 'ru': 'пять'},

    'select': {'en': 'Please select', 'de': 'Bitte auswählen', 'ru': 'Выберите'},

    //Messages
    'msgWarning': {'en': 'Warning', 'de': 'Warnung', 'ru': 'Ошибка'},
    'msgError': {'en': 'Error', 'de': 'Fehler', 'ru': 'Ошибка'},

    'msgMultipleZones': {
      'en': 'Don\'t use equal zones.', 'de': 'Zonen dürfen nicht doppelt belegt werden.', 'ru': 'Нельзя использовать зоны дважды',
    },

    'msgOnlyOneBridge': {
      'en': 'Only one iBox1 zone (zone 5)  can be of type bridge.',
      'de': 'Nur eine Zone (Zone 5) der iBox1 kann vom Typ Bridge sein.',
      'ru': 'Только одна зона (зона 5) в iBox1 может иметь тип Bridge',
    },

    'msgChangeCT': {
      'en': 'Changing controller type will delete all zones.',
      'de': 'Durch die Änderung des Controllertyps werden alle Zonen gelöscht.',
      'ru': 'При измении типа контроллера все зоны будут удалены',
    },
  };

  $('#zones').data('storage', {
    'nameZone': [], 'numberZone': [],
  });

  function setValue(id, value, onChange) {
    if ($('#' + id + '.value').prop('type') === 'checkbox') {
      $('#' + id + '.value').prop('checked', value).on('change', function () {
        setTimeout(function () {
          mslvalidator.form() ? onChange() : onChange(false);
        }, 0);
      });
    }
    else {
      $('#' + id + '.value').data('oldValue', $('#' + id + '.value').val());

      $('#' + id + '.value').val(value).on('keydown click', function (event) {
        if (mslvalidator.form()) {
          $(event.currentTarget).data('oldValue', $(event.currentTarget).val());
        }
      }).on('keyup', function (event) {
        setTimeout(function () {
          if (!mslvalidator.form()) {
            onChange(false);
          }
          else if (event.which !== 9 && event.which !== 16 &&
              $('#' + id + '.value').val() !== $('#' + id + '.value').data('oldValue')) {
            onChange();
          }
        }, 0);
      });
    }
  }

  function load(settings, onChange) {
    onChange(false);

    let maxRaw = undefined;

    const devices = settings.devices || [];
    const port = settings.controllerPort;

    for (let key in settings) {
      setValue(key, settings[key], onChange);
    }

    if (settings.controllerType === 'v6') {
      maxRaw = 5;

      $('th[data-name=numberZone]').attr('data-options', '0/nozone;1/zone1;2/zone2;3/zone3;4/zone4;5/zone5');
      $('th[data-name=typeZone]').attr('data-options', '0/notype;white/White;rgbw/RGB(W);fullColor/RGB + CWWW;bridge/Bridge (iBox1)');
    }
    else {
      maxRaw = 4;

      $('th[data-name=numberZone]').attr('data-options', '0/nozone;1/zone1;2/zone2;3/zone3;4/zone4');
      $('th[data-name=typeZone]').attr('data-options', '0/notype;white/White;rgbw/RGB(W)');
    }

    $('#devices').hide();
    $('#pager-devices').hide();

    /*----------------------------------------------------------------------------------------------------------------*/

    values2table('values', devices, onChange, function () {
      let selectedNumberZones = [];
      let bridgeFlag = false;

      $('select[data-name = numberZone]').each(function (i, el) {
        const val = $(el).val();

        if (val !== '0') { // numberZone ausgewählt
          selectedNumberZones.push(val);
        }
        $(this).data('oldNumberZone', val);
      }).on('focus', function () {
        const valNZ = $(this).val();

        $(this).data('oldNumberZone', valNZ);
      }).on('change', function () {
        const $selectNZ = $(this);
        const index = $selectNZ.data('index');
        const valNZ = $selectNZ.val();
        const oldNumberZone = $selectNZ.data('oldNumberZone');

        const $selectTZ = $('select[data-name=typeZone][data-index="' + index + '"]');

        if (valNZ !== '0') { // NumberZone ausgewählt?
          if (selectedNumberZones.indexOf(valNZ) !== -1) { // NumberZone bereits vorhanden

            $selectNZ.find('option[value="' + oldNumberZone + '"]').prop('selected', true);
            $selectNZ.trigger('change.adaptersettings'); // unbedingt erforderlich, da sonst values (adapter-settings.js) nicht aktualisiert wird!

            showMessage(_('msgMultipleZones'), _('msgWarning'), 'info');
          }
          else { // NumberZone noch nicht vorhanden
            selectedNumberZones.push(valNZ);

            if (oldNumberZone !== '0') {
              selectedNumberZones.splice(selectedNumberZones.indexOf(oldNumberZone), 1);

              if (oldNumberZone === '5') { // typeZone enablen und Auswahl auf '0'
                bridgeFlag = false;

                $selectTZ.removeProp('disabled').removeClass('msl-disabled');
                $selectTZ.find('option[value=0]').prop('selected', true);

                $selectTZ.trigger('change.adaptersettings');
              }
            }

            if (valNZ === '5') { // Bridge wurde ausgewählt -> typeZone muss gesetzt werden!
              bridgeFlag = true;

              $selectTZ.prop('disabled', true).addClass('msl-disabled');
              $selectTZ.find('option[value=bridge]').prop('selected', true);

              $selectTZ.trigger('change.adaptersettings');
            }

            $selectNZ.focusout().focus(); // Setzt oldNumberZone neu, da focus-Event emittiert wird!
          }
        }
        else { // oldNumberZone aus Array entfernen
          selectedNumberZones.splice(selectedNumberZones.indexOf(oldNumberZone), 1);

          if (oldNumberZone === '5') { // typeZone enablen und Auswahl auf '0'
            bridgeFlag = false;

            $selectTZ.removeProp('disabled').removeClass('msl-disabled');
            $selectTZ.find('option[value=0]').prop('selected', true);

            $selectTZ.trigger('change.adaptersettings');
          }

          $selectNZ.trigger('focus');
        }
      });

      $('select[data-name = typeZone]').each(function (i, el) {
        const $selectTZ = $(el);
        const valTZ = $selectTZ.val();

        if (valTZ === 'bridge') {
          $selectTZ.prop('disabled', true).addClass('msl-disabled');
          $selectTZ.find('option[value=bridge]').prop('selected', true);

          bridgeFlag = true;
        }

        $(this).data('oldTypeZone', valTZ);
      }).on('focus', function () {
        const val = $(this).val();

        $(this).data('oldTypeZone', val);
      }).on('change', function () {
        const $selectTZ = $(this);
        const index = $selectTZ.data('index');
        const valTZ = $selectTZ.val();
        const oldTypeZone = $selectTZ.data('oldTypeZone');

        const $selectNZ = $('select[data-name=numberZone][data-index="' + index + '"]');
        const oldNumberZone = $selectNZ.data('oldNumberZone');

        if (valTZ === 'bridge') {
          if (bridgeFlag === false) {
            bridgeFlag = true;

            $selectTZ.prop('disabled', true).addClass('msl-disabled');
            $selectNZ.find('option[value=5]').prop('selected', true);
            $selectNZ.trigger('change.adaptersettings');

            if (oldNumberZone !== '0') {
              selectedNumberZones.splice(selectedNumberZones.indexOf(oldNumberZone), 1);
            }

            selectedNumberZones.push('5');

            $selectTZ.data('oldTypeZone', valTZ);

            $selectNZ.focus();
          }
          else {
            $selectTZ.find('option[value="' + oldTypeZone + '"]').prop('selected', true);
            $selectTZ.trigger('change.adaptersettings');

            showMessage(_('msgOnlyOneBridge'), _('msgWarning'), 'info');
          }
        }
        else {
          $selectTZ.data('oldTypeZone', valTZ);
        }
      });

      $('#tab-1').find('select[data-name=room]').multiselect({
        header: _('select'),
        noneSelectedText: _('nonerooms'),
        minWidth: false,
        multiple: false,

        create: function () {
          const $that = $(this);

          $($that.multiselect('getButton')).css({'width': '100%', 'color': 'inherit', 'font-weight': 'inherit'});

          $($that.multiselect('widget')).css('width', 'auto');

          $that.multiselect('option', {
            selectedText: function () {
              return $that.children('option:checked').text();
            },
          });
        },
      });

      $('#tab-1').find('select[data-name=func]').multiselect({
        header: _('select'), noneSelectedText: _('nonefunctions'), minWidth: false, multiple: true,

        create: function () {
          const $that = $(this);

          $($that.multiselect('getButton')).css({'width': '100%', 'color': 'inherit', 'font-weight': 'inherit'});

          $($that.multiselect('widget')).css('width', 'auto');

          $that.multiselect('option', {
            selectedText: function () {
              selectedText = '';
              $that.children('option:checked').each(function (index) {
                index < $that.children('option:checked').length - 1 ? selectedText += $(this).text() + ' | ' : selectedText += $(this).text();
              });
              return selectedText;
            },
          });
        },
      });
    }, maxRaw);

    getIsAdapterAlive(function (isAlive) {
      if (isAlive || common.enabled) {
        const $discover = $('#discover');

        $discover.removeProp('disabled');
        $discover.click(function () {
          const $controllerFound = $('#controllerFound');

          $controllerFound.prop('disabled', true);

          sendTo(null, 'discover', null, function (list) {
            if (!list || !list.length) {
              showMessage(_('noController'), _('msgWarning'), 'info');
              return;
            }

            let selection = '<option class="translate">' + _('selectController') + '</option>';

            for (let i = 0; i < list.length; i++) {
              selection += '<optgroup label="' +
                  (list[i].name ? list[i].name + ' | ' + list[i].type + ' | ' + list[i].mac + '">' : list[i].type + ' | ' + list[i].mac + '">');
              selection += '<option value="' + list[i].ip + '"' + ' data-type="' + list[i].type + '">' + list[i].ip + '</option>';
              selection += '</optgroup>';
            }

            $controllerFound.html(selection).show();
            $controllerFound.removeProp('disabled');
          });
        });
      }
      else {
        $('#discover').prop('disabled', true);
      }
    });

    $('#controllerFound').change(function () {
      const $selected = $(this).find('option:selected');
      const val = $(this).val();
      const $controllerIp = $('#controllerIp');
      const $controllerType = $('#controllerType');

      if (val) {
        $('#controllerFound').css('display', 'none');
        $controllerIp.val(val);

        if ($selected.data('type') !== $controllerType.val()) {
          $controllerType.val($selected.data('type'));
          $controllerType.trigger('change', [$controllerIp.val()]);
        }

        mslvalidator.form() ? onChange() : onChange(false);
      }
    });

    $('#controllerType').change(function (event, controllerIpOld) {
      event.stopPropagation();

      const $thTypeZone = $('th[data-name=typeZone]');
      const $thNumberZone = $('th[data-name=numberZone]');
      const ct = $(this).val();

      confirmMessage(_('msgChangeCT'), _('msgWarning'), 'info', ['Ok', 'Cancel'], function (id) {
        if (!id) {
          if (ct === 'legacy') {
            maxRaw = 4;
            $('#controllerPort').val(port);

            $thNumberZone.removeData('options');
            $thNumberZone.attr('data-options', '0/' + _('nozone') + ';1/zone1;2/zone2;3/zone3;4/zone4');

            $thTypeZone.removeData('options');
            $thTypeZone.attr('data-options', '0/' + _('notype') + ';white/White;rgbw/RGB(W)');
          }
          else if (ct === 'v6') {
            maxRaw = 5;
            $('#controllerPort').val(port);

            $thNumberZone.removeData('options');
            $thNumberZone.attr('data-options', '0/' + _('nozone') + ';1/zone1;2/zone2;3/zone3;4/zone4;5/zone5');

            $thTypeZone.removeData('options');
            $thTypeZone.attr('data-options', '0/' + _('notype') + ';white/White;rgbw/RGB(W);fullColor/RGB + CWWW;bridge/Bridge (iBox1)');
          }

          sendTo(null, 'deletedevices', null, function (count) {
            values2table('values', [], onChange, function () {
              $('button#save').trigger('click');
            }, maxRaw);
          });

          //onChange();
          mslvalidator.form() ? onChange() : onChange(false);

        }
        else if (id) {
          if (ct === 'legacy') {
            $('#controllerType').val('v6');
          }
          else {
            $('#controllerType').val('legacy');
          }

          if (controllerIpOld) {
            $('#controllerIp').val(controllerIpOld);
          }

          onChange(false);
        }
      });
    });
  }

  function save(callback) {
    let obj = {};

    $('.value').each(function () {
      const $this = $(this);

      if ($this.prop('type') === 'checkbox') {
        obj[$this.prop('id')] = $this.prop('checked');
      }
      else {
        obj[$this.prop('id')] = $this.val();
      }
    });

    obj.devices = table2values('values');

    callback(obj);
  }
</script>

<div id="adapter-container">
    <div class="pure-g">
        <div class="pure-u-1 pure-u-md-2-24"><!--suppress CheckImageSize -->
            <img src="lib/images/milight-smart-light.png" height="65"/></div>
        <div class="pure-u-1 pure-u-md-22-24"><h1 class="translate">adapterSettings</h1></div>
    </div>

    <div id="tabs">
        <ul>
            <li><a href="#tab-0"><span class="translate">tabController</span></a></li>
            <li><a href="#tab-1"><span class="translate">tabZones</span></a></li>
        </ul>
        <div id="tab-0">
            <form id="controller" class="pure-form pure-form-aligned">
                <fieldset>
                    <legend><b class="translate">controllerParameter</b></legend>
                    <div class="pure-control-group">
                        <label for="controllerType" class="translate">conType</label>
                        <select name="controllerType" id="controllerType" class="value">
                            <option value="legacy">Legacy</option>
                            <option value="v6">Version 6</option>
                        </select>
                    </div>
                    <div class="pure-control-group">
                        <label for="controllerIp" class="translate">conIp</label>
                        <!--suppress XmlDefaultAttributeValue -->
                        <input type="text" name="controllerIp" id="controllerIp" class="value">

                        <button type="button" id="discover" class="pure-button">
                            <i class="ui-icon ui-icon-refresh"></i></button>

                        <!--suppress HtmlFormInputWithoutLabel -->
                        <select style="display: none;width: 15em" id="controllerFound"></select>
                    </div>
                    <div class="pure-control-group">
                        <label for="controllerPort" class="translate">conPort</label>
                        <!--suppress XmlDefaultAttributeValue -->
                        <input type="text" name="controllerPort" id="controllerPort" class="value">
                    </div>
                    <div class="pure-control-group">
                        <label for="commandRepeat" class="translate">conRepeatCommand</label>
                        <!--suppress XmlDefaultAttributeValue -->
                        <input type="text" name="commandRepeat" id="commandRepeat" class="value">
                    </div>
                    <div class="pure-control-group">
                        <label for="delayBetweenCommands" class="translate">conPauseBetweenCommands</label>
                        <!--suppress XmlDefaultAttributeValue -->
                        <input type="text" name="delayBetweenCommands" id="delayBetweenCommands" class="value">
                    </div>
                </fieldset>
            </form>
            <span class="translate">onSaveAdapter</span>
        </div>
        <div id="tab-1" class="pure-g">
            <div id="values" class="pure-u-1-1">
                <form class="pure-form pure-form-aligned">
                    <fieldset>
                        <legend><b class="translate">createZones</b></legend>
                    </fieldset>
                </form>
                <button class="table-button-add" style="margin-left: 10px; width: 2.5em; height: 2.5em"></button>
                <table id="zones" class="table-values pure-table" style="width: 100%;">
                    <thead>
                    <tr>
                        <th data-name="_index" data-style="text-align: right; width: 3em"></th>

                        <th data-name="activeZone" data-type="checkbox" data-tdstyle="text-align: center; width: 3em;" class="translate">thactive</th>

                        <th data-name="numberZone" data-type="select" data-tdstyle="width: 5em;" class="translate">thzone</th>

                        <th data-name="nameZone" data-tdstyle="width: 10em;" class="translate">thname</th>

                        <th data-name="typeZone" data-type="select" data-tdstyle="width: 10em;" class="translate">thtype</th>

                        <th data-name="nameType" data-tdstyle="width: 10em;" class="translate">thnametype</th>

                        <th data-name="room" data-type="select" data-tdstyle="width: 10em;" class="translate">throom</th>

                        <th data-name="func" data-type="select multiple" data-tdstyle="width: 15em;" class="translate">thfunction</th>

                        <th data-buttons="delete"></th>
                    </tr>
                    </thead>
                </table>
            </div>
            <div class="pure-u-1-1">
                <div class="translate" style="padding-top: 1em">onSaveAdapter</div>
            </div>
        </div>
    </div>
</div>
</html>
